$driveLetter = "D"
$minFreeGB = 100
$minFreeBytes = $minFreeGB * 1GB
$VHDPath = "$env:SystemDrive\DDrive.vhdx"

# Check if drive exists
$drive = Get-PSDrive -Name $driveLetter -ErrorAction SilentlyContinue
if ($drive) {
    if ($drive.Free -ge $minFreeBytes) {
        Write-Output "$driveLetter: exists and has enough free space ($([math]::Round($drive.Free/1GB)) GB)."
        exit
    } else {
        Write-Output "$driveLetter: exists but has insufficient free space ($([math]::Round($drive.Free/1GB)) GB)."
    }
} else {
    Write-Output "$driveLetter: does not exist. Creating virtual drive..."
}

# Create VHD using diskpart
$diskpartScript = @"
create vdisk file="$VHDPath" maximum=$($minFreeGB*1024) type=expandable
select vdisk file="$VHDPath"
attach vdisk
create partition primary
format fs=ntfs quick label=DDrive
assign letter=$driveLetter
exit
"@

# Run diskpart
$diskpartScript | diskpart

Write-Output "Drive $driveLetter: created successfully using virtual disk at $VHDPath."
