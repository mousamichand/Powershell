function Throw-Error($Message) {
Write-Error $Message
exit 1
}

try {
[string]$ZipUrl = "https://10.32.20.128/public-archives/download/azarchive/IIS10_2019.zip"
$expectedSize = 291100000

[int]$MinFreeGb = 50
[string]$TargetDrive = 'E:'
Write-Host "Validating $TargetDrive drive and free space..." -ForegroundColor Cyan

$driveLetter = ($TargetDrive).TrimEnd(':','\')
$targetPsDrive = Get-PSDrive -Name $driveLetter -ErrorAction SilentlyContinue
if (-not $targetPsDrive) {
    Throw-Error "$TargetDrive drive not found. Please attach or mount a $TargetDrive volume."
}

$freeGb = [math]::Round(($targetPsDrive.Free / 1GB), 2)
if ($freeGb -lt $MinFreeGb) {
    Throw-Error "Insufficient free space on $TargetDrive. Required: $MinFreeGb GB, Available: $freeGb GB."
}

Write-Host "$TargetDrive drive found with $freeGb GB free (>= $MinFreeGb GB required)." -ForegroundColor Green

$driveRoot = $targetPsDrive.Root
$downloadDir = Join-Path $driveRoot 'IIS_download'
$extractWorkDir = Join-Path $driveRoot 'IIS_extract_tmp'
$null = New-Item -Path $downloadDir -ItemType Directory -Force -ErrorAction Stop

$zipPath = Join-Path $downloadDir 'IIS10_2019.zip'
$extractDir = $extractWorkDir

Write-Host "Paths:" -ForegroundColor DarkCyan
Write-Host "  Download dir: $downloadDir" -ForegroundColor DarkCyan
Write-Host "  Zip path:     $zipPath" -ForegroundColor DarkCyan
Write-Host "  Extract dir:  $extractDir" -ForegroundColor DarkCyan

Write-Host "Downloading ZIP from: $ZipUrl" -ForegroundColor Yellow
$prevCallback = [System.Net.ServicePointManager]::ServerCertificateValidationCallback
$prevProto = [System.Net.ServicePointManager]::SecurityProtocol
$prevExpect = [System.Net.ServicePointManager]::Expect100Continue

[System.Net.ServicePointManager]::Expect100Continue = $false
[System.Net.ServicePointManager]::DefaultConnectionLimit = 16

$downloaded = $false
try {
    for ($i = 1; $i -le 3 -and -not $downloaded; $i++) {
        try {
            Invoke-WebRequest -Uri $ZipUrl -OutFile $zipPath -UseBasicParsing -ErrorAction Stop
            $downloaded = $true
        }
        catch {
            if ($i -eq 3) { throw }
            Start-Sleep -Seconds (2 * $i)
        }
    }
}
catch {
    Write-Warning ("Invoke-WebRequest failed, trying WebClient. Error: {0}" -f $_.Exception.Message)
    try {
        $maxRetries = 5
        $retryDelay = 5
        $wc = New-Object System.Net.WebClient
        for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
            try {
                Write-Host "[$attempt/$maxRetries] Downloading IIS Scripts..."
                $wc.DownloadFile($ZipUrl , $zipPath)
                if (Test-Path $zipPath) {
                    $fileSize = (Get-Item $zipPath).Length
                    if ($expectedSize -and $fileSize -lt $expectedSize) {
                        throw "Downloaded file size $fileSize bytes does not match expected $expectedSize bytes."
                    }
                    if ($fileSize -gt 0) {
                        Write-Host "Download complete: $fileSize bytes"
                        break
                    }
                }
                throw "File not downloaded or size is zero."
            }
            catch {
                Write-Warning "Download failed: $($_.Exception.Message)"
                if ($attempt -lt $maxRetries) {
                    Write-Host "Retrying in $retryDelay seconds..."
                    Start-Sleep -Seconds $retryDelay
                }
                else {
                    throw "All $maxRetries attempts failed."
                }
            }
        }
    }
    catch {
        Write-Warning ("WebClient download failed. Error: {0}" -f $_.Exception.Message)
        $curlCmd = $null
            $curlCmdInfo = Get-Command curl.exe -ErrorAction SilentlyContinue
            if (-not $curlCmdInfo) { Write-Host "curl.exe not found. Installing curl via winget..." -ForegroundColor Yellow try { Start-Process -FilePath "winget" -ArgumentList "install --id curl.Curl -e --accept-package-agreements --accept-source-agreements" -Wait -NoNewWindow } catch { Throw-Error "Failed to install curl.exe via winget." } }
            if ($curlCmdInfo) { $curlCmd = $curlCmdInfo.Source } else { $curlCmd = "C:\\Windows\\System32\\curl.exe" }
            if (Test-Path -LiteralPath $curlCmd) {
                Write-Host ("Attempting curl fallback: '{0}'" -f $curlCmd) -ForegroundColor Yellow
                $curlArgs = @('-g','-k','-L',"$ZipUrl",'-o',"$zipPath")
                $proc = Start-Process -FilePath $curlCmd -ArgumentList $curlArgs -NoNewWindow -PassThru -Wait
                if ($proc.ExitCode -eq 0 -and (Test-Path -LiteralPath $zipPath) -and ((Get-Item $zipPath).Length -gt 0)) {
                    $downloaded = $true
                }
            else {
                Throw-Error ("curl.exe fallback failed. ExitCode={0}. URL='{1}'" -f $proc.ExitCode, $ZipUrl)
            }
        }
        else {
            Throw-Error ("curl.exe installation failed or not found. URL='{0}'" -f $ZipUrl)
        }
    }
}
finally {
    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = $prevCallback
    [System.Net.ServicePointManager]::SecurityProtocol = $prevProto
    [System.Net.ServicePointManager]::Expect100Continue = $prevExpect
}
Write-Host "Downloaded to: $zipPath" -ForegroundColor Green

Write-Host "Extracting ZIP to: $extractDir" -ForegroundColor Yellow
if (Test-Path $extractWorkDir) { Remove-Item -Path $extractWorkDir -Recurse -Force -ErrorAction SilentlyContinue }
try { Expand-Archive -LiteralPath $zipPath -DestinationPath $extractDir -Force }
catch { Throw-Error ("Failed to extract archive. ZipPath='{0}', Dest='{1}'. Error='{2}'" -f $zipPath, $extractDir, $_) }
Write-Host "Extraction complete." -ForegroundColor Green

$contentRoot = $extractDir
$topEntries = Get-ChildItem -LiteralPath $extractDir -Force | Where-Object { $_.Name -ne '__MACOSX' }
if ($topEntries.Count -eq 1 -and $topEntries[0].PSIsContainer) { $contentRoot = $topEntries[0].FullName }

Write-Host ("Moving extracted contents from '{0}' to '{1}'" -f $contentRoot, $driveRoot) -ForegroundColor Yellow
robocopy "$contentRoot" "$driveRoot" *.* /E /NFL /NDL /NJH /NJS /NP | Out-Null

Remove-Item -LiteralPath $zipPath -Force -ErrorAction SilentlyContinue
Remove-Item -LiteralPath $downloadDir -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -LiteralPath $extractWorkDir -Recurse -Force -ErrorAction SilentlyContinue

$candidateInstallPaths = @(
    (Join-Path (Join-Path $driveRoot 'IIS10') 'install-iis10-script.ps1'),
    (Join-Path $driveRoot 'install-iis10-script.ps1')
)
$installScript = $null
foreach ($p in $candidateInstallPaths) { if (Test-Path -LiteralPath $p) { $installScript = $p; break } }
if (-not (Test-Path $installScript)) { Throw-Error "Missing '$installScript'. Ensure your installer script exists." }

Write-Host "Launching installer as Administrator: $installScript" -ForegroundColor Cyan
$args = "-ExecutionPolicy Bypass -NoProfile -File `"$installScript`""
Start-Process -FilePath "powershell.exe" -Verb RunAs -ArgumentList $args -Wait

Write-Host "Verifying IIS service (W3SVC) status..." -ForegroundColor Yellow
$svc = Get-Service -Name W3SVC -ErrorAction SilentlyContinue
if ($svc) {
    if ($svc.Status -ne 'Running') { try { Start-Service -Name W3SVC -ErrorAction Stop } catch { Write-Warning "Failed to start W3SVC: $($_.Exception.Message)" } }
    $svc.Refresh()
    Write-Host ("W3SVC status: {0}" -f $svc.Status) -ForegroundColor Green
}
else { Write-Warning "W3SVC service not found. Ensure IIS role installed successfully." }

Write-Host "Bootstrap completed successfully." -ForegroundColor Cyan
exit 0
```

}
catch {
Write-Error $_
exit 1
}
