# Fully Dynamic IIS & .NET Validation Script

Import-Module WebAdministration -ErrorAction SilentlyContinue
$checks = @()

# Set expected Windows version
$ExpectedWindowsVersion = "<%=customOptions.layoutId%>"  # replace with morpheus custom option var

# Get current Windows ProductName
$winInfo = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion"
$windowsVersion = $winInfo.ProductName

# Compare with expected version
$status = if ($windowsVersion -like "*$ExpectedWindowsVersion*") { 
    "Match" 
} else { 
    "Mismatch" 
}

# Output as table row
$checks += [pscustomobject]@{
    Check  = "Windows Server Version"
    Status = $status
    Path   = $windowsVersion
} 


# Set expected IIS version
$ExpectedIISVersion = "10.0"   # e.g., "10.0" for IIS 10 # replace with morpheus custom option var



# Registry path for IIS
$iisRegPath = "HKLM:\SOFTWARE\Microsoft\InetStp"

if (Test-Path $iisRegPath) {
    $iisVersion = (Get-ItemProperty $iisRegPath).VersionString
    $status = if ($iisVersion -like "*$ExpectedIISVersion*") { "Match" } else { "Mismatch" }
} else {
    $iisVersion = "Not Installed"
    $status = "Missing"
}

# Output as table row
$checks += [pscustomobject]@{
    Check  = "IIS Version"
    Status = $status
    Path   = $iisVersion
} 


# -----------------------
# IIS & Services
# -----------------------
$webMgmtInstalled = $false
if (Get-Module -ListAvailable -Name ServerManager) {
    Import-Module ServerManager -ErrorAction SilentlyContinue
    $webMgmtInstalled = (Get-WindowsFeature Web-Mgmt-Console).Installed
}

$checks += [pscustomobject]@{
    Check  = "IIS Console"
    Status = if ($webMgmtInstalled) { "Installed" } else { "Missing" }
}

# Function to safely get service status
function Get-ServiceStatusSafe {
    param([string]$ServiceName)
    $svc = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
    if ($svc) {
        if ($svc.Status -eq 'Running') { return "Running" } else { return "Stopped" }
    } else {
        return "Not Installed"
    }
}

$checks += [pscustomobject]@{
    Check  = "WAS Service"
    Status = Get-ServiceStatusSafe -ServiceName "WAS"
}
$checks += [pscustomobject]@{
    Check  = "W3SVC Service"
    Status = Get-ServiceStatusSafe -ServiceName "W3SVC"
}

# -----------------------
# .NET 4.8 Check
# -----------------------
$net48 = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" -ErrorAction SilentlyContinue).Release
$checks += [pscustomobject]@{
    Check  = ".NET 4.8"
    Status = if ($net48 -ge 528040) { "Installed" } else { "Missing" }
}

# -----------------------
# IIS Installation Path (Registry - InstallPath)
# -----------------------
$iisInstallReg = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\InetStp" -Name "InstallPath" -ErrorAction SilentlyContinue
$installPath = if ($iisInstallReg -and $iisInstallReg.InstallPath) { $iisInstallReg.InstallPath } else { $null }

$checks += [pscustomobject]@{
    Check  = "IIS Installation Path"
    Status = if ($installPath -and (Test-Path $installPath)) { "Exists" } else { "Missing" }
    Path   = if ($installPath) { $installPath } else { "N/A" }
}

# -----------------------
# Default Website Path (Registry - PathWWWRoot)
# -----------------------
$wwwRootReg = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\InetStp" -Name "PathWWWRoot" -ErrorAction SilentlyContinue
$wwwRootPath = if ($wwwRootReg -and $wwwRootReg.PathWWWRoot) { $wwwRootReg.PathWWWRoot } else { $null }

$checks += [pscustomobject]@{
    Check  = "Default Website Path"
    Status = if ($wwwRootPath -and (Test-Path $wwwRootPath)) { "Exists" } else { "Missing" }
    Path   = if ($wwwRootPath) { $wwwRootPath } else { "N/A" }
}

# -----------------------
# Default App Pool (assigned to default website)
# -----------------------
$defaultSite = Get-Website -ErrorAction SilentlyContinue | Where-Object { $_.physicalPath -eq $wwwRootPath } | Select-Object -First 1
$appPoolName = if ($defaultSite) { $defaultSite.applicationPool } else { $null }
$appPool = if ($appPoolName) { Get-Item "IIS:\AppPools\$appPoolName" -ErrorAction SilentlyContinue } else { $null }

$checks += [pscustomobject]@{
    Check  = "Default App Pool"
    Status = if ($appPool) { "Present" } else { "Missing" }
    Path   = if ($appPoolName) { $appPoolName } else { "N/A" }
}

# -----------------------
# QUAL.HTML page accessibility
# -----------------------
$pageUrl = "http://localhost/QUAL.HTML"
try {
    $resp = Invoke-WebRequest $pageUrl -UseBasicParsing -ErrorAction Stop
    $pageStatus = "Accessible"
} catch {
    $pageStatus = "Not Accessible"
}

$checks += [pscustomobject]@{
    Check  = "QUAL.HTML Page"
    Status = $pageStatus
    Path   = $pageUrl
}

# -----------------------
# Display Final Table
# -----------------------
$checks | Format-Table -AutoSize
