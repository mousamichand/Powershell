# Fully Dynamic IIS & .NET Validation Script

Import-Module WebAdministration -ErrorAction SilentlyContinue
$checks = @()

# Set expected Windows version
$layoutId = "<%=customOptions.layoutId%>"

# Check if it equals 2019
# Conditional assignment
if ($layoutId -eq 582) {
    $ExpectedWindowsVersion = "2019"
} else {
    $ExpectedWindowsVersion = "2022"
}


# Get current Windows ProductName
$winInfo = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion"
$windowsVersion = $winInfo.ProductName

# Compare with expected version
$status = if ($windowsVersion -like "*$ExpectedWindowsVersion*") { 
    "Match" 
} else { 
    "Mismatch" 
}

# Output as table row
$checks += [pscustomobject]@{
    Check  = "Windows Server Version"
    Status = $status
    Path   = $windowsVersion
} 


# Set expected IIS version
$ExpectedIISVersion = "10.0"   # e.g., "10.0" for IIS 10 # replace with morpheus custom option var



# Registry path for IIS
$iisRegPath = "HKLM:\SOFTWARE\Microsoft\InetStp"

if (Test-Path $iisRegPath) {
    $iisVersion = (Get-ItemProperty $iisRegPath).VersionString
    $status = if ($iisVersion -like "*$ExpectedIISVersion*") { "Match" } else { "Mismatch" }
} else {
    $iisVersion = "Not Installed"
    $status = "Missing"
}

# Output as table row
$checks += [pscustomobject]@{
    Check  = "IIS Version"
    Status = $status
    Path   = $iisVersion
} 


# -----------------------
# IIS & Services
# -----------------------
$webMgmtInstalled = $false
if (Get-Module -ListAvailable -Name ServerManager) {
    Import-Module ServerManager -ErrorAction SilentlyContinue
    $webMgmtInstalled = (Get-WindowsFeature Web-Mgmt-Console).Installed
}
# Verify 5.1.1	Launching IIS Administration console
$checks += [pscustomobject]@{
    Check  = " 5.1.1	Launching IIS Administration console  "
    Status = if ($webMgmtInstalled) { "PASS" } else { "FAIL" }
}

# 5.1.2	Verify Presence of IIS Services ,WAS and W3SVC service should be running. 
function Get-ServiceStatusSafe {
    param([string]$ServiceName)
    $svc = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
    if ($svc) {
        if ($svc.Status -eq 'Running') { return "PASS" } else { return "FAIL" }
    } else {
        return "FAIL"
    }
}

$checks += [pscustomobject]@{
    Check  = " 5.1.2	IIS WAS Service is Running"
    Status = Get-ServiceStatusSafe -ServiceName "WAS"
}
$checks += [pscustomobject]@{
    Check  = "5.1.2	 IIS W3SVC Service is Running"
    Status = Get-ServiceStatusSafe -ServiceName "W3SVC"
}

# -----------------------
#5.1.3	Presence of .Net framework V 4.8
# -----------------------
$net48 = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" -ErrorAction SilentlyContinue).Release
$checks += [pscustomobject]@{
    Check  = ".Net framework V 4.8 is installed. "
    Status = if ($net48 -ge 528040) { "PASS" } else { "FAIL" }
}

# -----------------------
# 5.1.5	Presence of IIS installation path and IIS log path 
# -----------------------
$iisInstallReg = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\InetStp" -Name "InstallPath" -ErrorAction SilentlyContinue
$installPath = if ($iisInstallReg -and $iisInstallReg.InstallPath) { $iisInstallReg.InstallPath } else { $null }

$checks += [pscustomobject]@{
    Check  = "IIS Installation Path"
    Status = if ($installPath -and (Test-Path $installPath)) { "PASS" } else { "FAIL" }
    Path   = if ($installPath) { $installPath } else { "N/A" }
}

# -----------------------
# 5.1.4	Presence of default website configuration and  Default Website Path (Registry - PathWWWRoot)
# -----------------------
$wwwRootReg = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\InetStp" -Name "PathWWWRoot" -ErrorAction SilentlyContinue
$wwwRootPath = if ($wwwRootReg -and $wwwRootReg.PathWWWRoot) { $wwwRootReg.PathWWWRoot } else { $null }

$checks += [pscustomobject]@{
    Check  = "Default Website Path"
    Status = if ($wwwRootPath -and (Test-Path $wwwRootPath)) { "PASS } else { "FAIL" }
    Path   = if ($wwwRootPath) { $wwwRootPath } else { "N/A" }
}

# -----------------------
# 5.1.4 Presence of  Default App Pool Configuration  (assigned to default website)
# -----------------------
$defaultSite = Get-Website -ErrorAction SilentlyContinue | Where-Object { $_.physicalPath -eq $wwwRootPath } | Select-Object -First 1
$appPoolName = if ($defaultSite) { $defaultSite.applicationPool } else { $null }
$appPool = if ($appPoolName) { Get-Item "IIS:\AppPools\$appPoolName" -ErrorAction SilentlyContinue } else { $null }

$checks += [pscustomobject]@{
    Check  = "Default App Pool"
    Status = if ($appPool) { "PASS" } else { "FAIL" }
    Path   = if ($appPoolName) { $appPoolName } else { "N/A" }
}

# -----------------------
# 5.1.6	Accessibility of default website with test page/qual page. QUAL.HTML page accessibility
# -----------------------
$pageUrl = "http://localhost/QUAL.HTML"
try {
    $resp = Invoke-WebRequest $pageUrl -UseBasicParsing -ErrorAction Stop
    $pageStatus = "Accessible"
} catch {
    $pageStatus = "Not Accessible"
}

$checks += [pscustomobject]@{
    Check  = "QUAL.HTML Page"
    Status = $pageStatus
    Path   = $pageUrl
}

# -----------------------
# Display Final Table
# -----------------------
$checks | Format-Table -AutoSize
